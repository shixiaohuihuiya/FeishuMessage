name: Feishu Daily Reminder with Signature

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹ (UTC+8) = UTCæ—¶é—´å‡Œæ™¨1ç‚¹
    - cron: '0 1 * * *'
    # åŒ—äº¬æ—¶é—´ä¸‹åˆ3ç‚¹ (UTC+8) = UTCæ—¶é—´æ—©ä¸Š7ç‚¹
    - cron: '0 7 * * *'

env:
  FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
  FEISHU_SECRET: ${{ secrets.FEISHU_SECRET }}

jobs:
  send-daily-reminder:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate Configuration
      run: |
        if [ -z "$FEISHU_WEBHOOK_URL" ]; then
          echo "âŒ é”™è¯¯: FEISHU_WEBHOOK_URL æœªé…ç½®"
          echo "è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½® FEISHU_WEBHOOK_URL"
          exit 1
        fi
        
        if [ -z "$FEISHU_SECRET" ]; then
          echo "âš ï¸ è­¦å‘Š: FEISHU_SECRET æœªé…ç½®ï¼Œå°†å‘é€æ— ç­¾åéªŒè¯çš„æ¶ˆæ¯"
        else
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          echo "Webhook URL: $(echo $FEISHU_WEBHOOK_URL | cut -d'/' -f1-5)/***"
          echo "Secret: ***"
        fi

    - name: Calculate Beijing Time and Message Type
      id: time-calc
      run: |
        # è·å–å½“å‰UTCæ—¶é—´
        UTC_HOUR=$(date -u +%H)
        UTC_MINUTE=$(date -u +%M)
        echo "å½“å‰UTCæ—¶é—´: ${UTC_HOUR}:${UTC_MINUTE}"
        
        # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
        BEIJING_HOUR=$(( (UTC_HOUR + 8) % 24 ))
        echo "å½“å‰åŒ—äº¬æ—¶é—´: ${BEIJING_HOUR}:${UTC_MINUTE}"
        
        # åˆ¤æ–­æ¶ˆæ¯ç±»å‹
        if [ $BEIJING_HOUR -lt 12 ]; then
          MSG_TYPE="morning"
          SCHEDULE_NAME="ä¸Šåˆæé†’"
          echo "å‘é€ä¸Šåˆæé†’æ¶ˆæ¯"
        else
          MSG_TYPE="afternoon" 
          SCHEDULE_NAME="ä¸‹åˆæé†’"
          echo "å‘é€ä¸‹åˆæé†’æ¶ˆæ¯"
        fi
        
        # è§¦å‘ç±»å‹
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          TRIGGER_TYPE="æ‰‹åŠ¨è§¦å‘"
        else
          TRIGGER_TYPE="è‡ªåŠ¨å®šæ—¶"
        fi
        
        echo "MESSAGE_TYPE=${MSG_TYPE}" >> $GITHUB_OUTPUT
        echo "SCHEDULE_NAME=${SCHEDULE_NAME}" >> $GITHUB_OUTPUT
        echo "TRIGGER_TYPE=${TRIGGER_TYPE}" >> $GITHUB_OUTPUT
        echo "BEIJING_HOUR=${BEIJING_HOUR}" >> $GITHUB_OUTPUT

    - name: Generate Feishu Signature
      id: signature
      run: |
        # ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆç§’çº§ï¼‰
        TIMESTAMP=$(date +%s)
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆéšæœºæ•°
        NONCE=$(openssl rand -hex 16)
        echo "nonce=${NONCE}" >> $GITHUB_OUTPUT
        
        # å¦‚æœæœ‰SECRETï¼Œç”Ÿæˆç­¾å
        if [ -n "$FEISHU_SECRET" ]; then
          # é£ä¹¦ç­¾åç®—æ³•ï¼štimestamp + "\n" + secret
          SIGNATURE_STRING="${TIMESTAMP}\n${FEISHU_SECRET}"
          
          # è®¡ç®—ç­¾å (base64 encoded SHA256)
          SIGNATURE=$(printf "$SIGNATURE_STRING" | openssl dgst -sha256 -binary | base64)
          echo "signature=${SIGNATURE}" >> $GITHUB_OUTPUT
          echo "âœ… ç­¾åç”ŸæˆæˆåŠŸ"
          echo "Timestamp: ${TIMESTAMP}"
          echo "Nonce: ${NONCE}"
          echo "Signature: ${SIGNATURE}"
        else
          echo "signature=" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æœªç”Ÿæˆç­¾å (FEISHU_SECRET æœªè®¾ç½®)"
        fi

    - name: Prepare Message Content
      id: message-content
      run: |
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        echo "beijing_time=${BEIJING_TIME}" >> $GITHUB_OUTPUT
        
        # ä¸Šåˆæ¶ˆæ¯å†…å®¹
        if [ "${{ steps.time-calc.outputs.MESSAGE_TYPE }}" == "morning" ]; then
          echo "TITLE=ğŸŒ æ—©å®‰ï¼å¼€å§‹ä»Šå¤©çš„å·¥ä½œå§" >> $GITHUB_OUTPUT
          echo "TEMPLATE=wathet" >> $GITHUB_OUTPUT
          echo "BUTTON_TEXT=ğŸ‘ æ”¶åˆ°ï¼Œå¼€å§‹å·¥ä½œ" >> $GITHUB_OUTPUT
          
          # éšæœºä¸Šåˆé¼“åŠ±è¯­
          MORNING_TIPS=(
            "æ¸…æ™¨çš„é˜³å…‰å¸¦æ¥æ–°çš„å¸Œæœ›ï¼Œä»Šå¤©åˆæ˜¯å……æ»¡æœºé‡çš„ä¸€å¤©ï¼âœ¨"
            "æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ï¼Œæ¯ä¸€æ¬¡åŠªåŠ›éƒ½åœ¨ç§¯ç´¯æˆåŠŸï¼ğŸ’ª"
            "ç”¨å¾®ç¬‘å¼€å§‹æ–°çš„ä¸€å¤©ï¼Œç”¨è¡ŒåŠ¨åˆ›é€ ç¾å¥½æˆæœï¼ğŸš€"
            "ä¿æŒç§¯æå¿ƒæ€ï¼Œå·¥ä½œæ•ˆç‡è‡ªç„¶æå‡ï¼ä»Šå¤©ä¹Ÿæ˜¯å……æ»¡å¸Œæœ›çš„ä¸€å¤©ï¼ğŸŒˆ"
            "ç›¸ä¿¡è‡ªå·±ï¼Œä»Šå¤©çš„ä½ æ¯”æ˜¨å¤©æ›´ä¼˜ç§€ï¼ğŸŒŸ"
          )
          INDEX=$(( RANDOM % ${#MORNING_TIPS[@]} ))
          SELECTED_TIP="${MORNING_TIPS[$INDEX]}"
          
          CONTENT="**ğŸ“‹ ä»Šæ—¥å·¥ä½œæé†’**\n\nğŸ¯ **é‡è¦ä»»åŠ¡æ£€æŸ¥ï¼š**\nâ€¢ 60è¡¨æ˜¯å¦å·²ä¸Šä¼ ï¼Ÿ\nâ€¢ æ˜¨æ—¥å·¥ä½œæ˜¯å¦å·²å®Œæˆï¼Ÿ\nâ€¢ ä»Šæ—¥è®¡åˆ’æ˜¯å¦æ˜ç¡®ï¼Ÿ\n\nğŸ’« **ä»Šæ—¥å¯„è¯­ï¼š**\n${SELECTED_TIP}"
          echo "CONTENT=${CONTENT}" >> $GITHUB_OUTPUT
          
          TIPS="ğŸŒˆ **å·¥ä½œå°è´´å£«ï¼š**\nâ€¢ å…ˆå®Œæˆæœ€é‡è¦çš„ä»»åŠ¡\nâ€¢ ä¿æŒä¸“æ³¨ï¼Œä¸€æ¬¡åªåšä¸€ä»¶äº‹\nâ€¢ è®°å¾—é€‚å½“ä¼‘æ¯ï¼Œä¿æŠ¤çœ¼ç›\nâ€¢ ä¿æŒæ¡Œé¢æ•´æ´ï¼Œå¿ƒæƒ…æ›´æ„‰æ‚¦"
          echo "TIPS=${TIPS}" >> $GITHUB_OUTPUT
          
        # ä¸‹åˆæ¶ˆæ¯å†…å®¹  
        else
          echo "TITLE=â˜• ä¸‹åˆå¥½ï¼ç»§ç»­åŠ æ²¹" >> $GITHUB_OUTPUT
          echo "TEMPLATE=orange" >> $GITHUB_OUTPUT
          echo "BUTTON_TEXT=ğŸ’ª ç»§ç»­åŠªåŠ›" >> $GITHUB_OUTPUT
          
          # éšæœºä¸‹åˆé¼“åŠ±è¯­
          AFTERNOON_TIPS=(
            "ä¸‹åˆæ˜¯åˆ›é€ å¥‡è¿¹çš„æ—¶é—´ï¼ç»§ç»­ä¿æŒä¸“æ³¨ï¼Œèƒœåˆ©åœ¨æœ›ï¼âœ¨"
            "åšæŒå°±æ˜¯èƒœåˆ©ï¼Œä¸‹åˆçš„å·¥ä½œåŒæ ·é‡è¦ï¼ğŸ’ª"
            "å–æ¯å’–å•¡ï¼Œè°ƒæ•´çŠ¶æ€ï¼Œç»§ç»­å‘ç›®æ ‡å‰è¿›ï¼ğŸš€"
            "æ¯ä¸€æ¬¡åšæŒéƒ½åœ¨å‘æˆåŠŸé è¿‘ï¼Œä¸‹åˆç»§ç»­åŠ æ²¹ï¼ğŸŒˆ"
            "ä¿æŒèŠ‚å¥ï¼Œç¨³æ‰ç¨³æ‰“ï¼Œä»Šå¤©çš„ç›®æ ‡ä¸€å®šèƒ½å®Œæˆï¼ğŸŒŸ"
          )
          INDEX=$(( RANDOM % ${#AFTERNOON_TIPS[@]} ))
          SELECTED_TIP="${AFTERNOON_TIPS[$INDEX]}"
          
          CONTENT="**ğŸ“Š ä¸‹åˆå·¥ä½œæ£€æŸ¥**\n\nğŸ¯ **è¿›åº¦ç¡®è®¤ï¼š**\nâ€¢ 60è¡¨æ˜¯å¦å·²æŒ‰æ—¶ä¸Šä¼ ï¼Ÿ\nâ€¢ ä¸Šåˆä»»åŠ¡å®Œæˆæƒ…å†µå¦‚ä½•ï¼Ÿ\nâ€¢ ä¸‹åˆå·¥ä½œé‡ç‚¹æ˜ç¡®äº†å—ï¼Ÿ\n\nğŸ’ª **åŠ æ²¹é¼“åŠ±ï¼š**\n${SELECTED_TIP}"
          echo "CONTENT=${CONTENT}" >> $GITHUB_OUTPUT
          
          TIPS="ğŸŒŸ **ä¸‹åˆå·¥ä½œå»ºè®®ï¼š**\nâ€¢ å›é¡¾ä¸Šåˆè¿›åº¦ï¼Œè°ƒæ•´ä¸‹åˆè®¡åˆ’\nâ€¢ å¤„ç†éœ€è¦æ·±åº¦æ€è€ƒçš„ä»»åŠ¡\nâ€¢ é€‚å½“æ´»åŠ¨ï¼Œä¿æŒç²¾åŠ›å……æ²›\nâ€¢ ä¸ºæ˜å¤©çš„å·¥ä½œåšå¥½å‡†å¤‡"
          echo "TIPS=${TIPS}" >> $GITHUB_OUTPUT
        fi

    - name: Send Message to Feishu
      run: |
        # æ„å»ºè¯·æ±‚å¤´
        HEADERS=(
          "-H" "Content-Type: application/json"
        )
        
        # å¦‚æœæœ‰ç­¾åï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
        if [ -n "${{ steps.signature.outputs.signature }}" ]; then
          HEADERS+=("-H" "X-Lark-Signature: ${{ steps.signature.outputs.signature }}")
          HEADERS+=("-H" "X-Lark-Request-Timestamp: ${{ steps.signature.outputs.timestamp }}")
          HEADERS+=("-H" "X-Lark-Request-Nonce: ${{ steps.signature.outputs.nonce }}")
          echo "ğŸ” ä½¿ç”¨ç­¾åéªŒè¯å‘é€æ¶ˆæ¯"
        else
          echo "â„¹ï¸ å‘é€æ— ç­¾åéªŒè¯çš„æ¶ˆæ¯"
        fi
        
        # æ„å»ºè¯·æ±‚æ•°æ®
        REQUEST_JSON=$(cat <<EOF
{
  "msg_type": "interactive",
  "card": {
    "config": {
      "wide_screen_mode": true
    },
    "header": {
      "title": {
        "tag": "plain_text",
        "content": "${{ steps.message-content.outputs.TITLE }}"
      },
      "template": "${{ steps.message-content.outputs.TEMPLATE }}"
    },
    "elements": [
      {
        "tag": "div",
        "text": {
          "tag": "lark_md",
          "content": "${{ steps.message-content.outputs.CONTENT }}\n\nâ° **æé†’æ—¶é—´ï¼š** ${{ steps.message-content.outputs.beijing_time }}\nğŸ•’ **æé†’æ—¶æ®µï¼š** ${{ steps.time-calc.outputs.SCHEDULE_NAME }}\nğŸ”§ **è§¦å‘æ–¹å¼ï¼š** ${{ steps.time-calc.outputs.TRIGGER_TYPE }}"
        }
      },
      {
        "tag": "hr"
      },
      {
        "tag": "div",
        "text": {
          "tag": "lark_md",
          "content": "${{ steps.message-content.outputs.TIPS }}"
        }
      },
      {
        "tag": "action",
        "actions": [
          {
            "tag": "button",
            "text": {
              "tag": "plain_text",
              "content": "${{ steps.message-content.outputs.BUTTON_TEXT }}"
            },
            "type": "primary",
            "url": "https://github.com/${{ github.repository }}"
          }
        ]
      }
    ]
  }
}
EOF
        )
        
        echo "ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°é£ä¹¦..."
        echo "URL: $(echo $FEISHU_WEBHOOK_URL | cut -d'/' -f1-5)/***"
        
        # å‘é€è¯·æ±‚
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "$FEISHU_WEBHOOK_URL" \
          "${HEADERS[@]}" \
          -d "$REQUEST_JSON")
        
        # è§£æå“åº”
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
        
        echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
        echo "å“åº”å†…å®¹: $RESPONSE_BODY"
        
        # éªŒè¯å“åº”
        if [ "$HTTP_CODE" -eq 200 ]; then
          if echo "$RESPONSE_BODY" | grep -q '"StatusCode":0'; then
            echo "âœ… é£ä¹¦æ¶ˆæ¯å‘é€æˆåŠŸï¼"
            echo "ğŸ“ æ¶ˆæ¯ç±»å‹: ${{ steps.time-calc.outputs.SCHEDULE_NAME }}"
            echo "â° å‘é€æ—¶é—´: ${{ steps.message-content.outputs.beijing_time }}"
          else
            echo "âŒ é£ä¹¦APIè¿”å›é”™è¯¯"
            echo "é”™è¯¯è¯¦æƒ…: $RESPONSE_BODY"
            exit 1
          fi
        else
          echo "âŒ HTTPè¯·æ±‚å¤±è´¥"
          echo "çŠ¶æ€ç : $HTTP_CODE"
          echo "é”™è¯¯è¯¦æƒ…: $RESPONSE_BODY"
          exit 1
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ é£ä¹¦æ¯æ—¥æé†’ä»»åŠ¡å®Œæˆï¼"
        echo "================================="
        echo "ğŸ“… å‘é€æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“ æ¶ˆæ¯ç±»å‹: ${{ steps.time-calc.outputs.SCHEDULE_NAME }}"
        echo "ğŸ”§ è§¦å‘æ–¹å¼: ${{ steps.time-calc.outputs.TRIGGER_TYPE }}"
        echo "ğŸ·ï¸ ç­¾åéªŒè¯: $([ -n "${{ steps.signature.outputs.signature }}" ] && echo "å·²å¯ç”¨" || echo "æœªå¯ç”¨")"
        echo "================================="
        echo "è¯·æ£€æŸ¥é£ä¹¦ç¾¤èŠæ˜¯å¦æ”¶åˆ°æ¶ˆæ¯ ğŸ“±"

    - name: Failure Notification
      if: failure()
      run: |
        echo "ğŸ’¥ é£ä¹¦æ¶ˆæ¯å‘é€å¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š"
        echo "1. âœ… FEISHU_WEBHOOK_URL æ˜¯å¦æ­£ç¡®é…ç½®"
        echo "2. âœ… FEISHU_SECRET æ˜¯å¦ä¸é£ä¹¦æœºå™¨äººé…ç½®ä¸€è‡´"
        echo "3. ğŸ”— ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
        echo "4. â° é£ä¹¦æœºå™¨äººæ˜¯å¦åœ¨ç¾¤èŠä¸­å¯ç”¨"
        echo "5. ğŸ”‘ æœºå™¨äººæƒé™æ˜¯å¦è¶³å¤Ÿ"
        exit 1
