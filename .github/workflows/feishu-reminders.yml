name: Feishu Daily Reminder with Signature

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹ (UTC+8) = UTCæ—¶é—´å‡Œæ™¨1ç‚¹
    - cron: '0 1 * * *'
    # åŒ—äº¬æ—¶é—´ä¸‹åˆ3ç‚¹ (UTC+8) = UTCæ—¶é—´æ—©ä¸Š7ç‚¹
    - cron: '0 7 * * *'

env:
  FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
  FEISHU_SIGN_SECRET: ${{ secrets.FEISHU_SIGN_SECRET }}

jobs:
  send-daily-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Configuration
        run: |
          echo "ğŸ”§ æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®..."
          
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "âŒ é”™è¯¯: FEISHU_WEBHOOK_URL æœªé…ç½®"
            exit 1
          else
            echo "âœ… FEISHU_WEBHOOK_URL å·²é…ç½®"
          fi
          
          if [ -z "$FEISHU_SIGN_SECRET" ]; then
            echo "âŒ é”™è¯¯: FEISHU_SIGN_SECRET æœªé…ç½®"
            exit 1
          else
            echo "âœ… FEISHU_SIGN_SECRET å·²é…ç½®"
          fi

      - name: Calculate Beijing Time
        id: time-check
        run: |
          # è·å–å½“å‰UTCæ—¶é—´
          UTC_HOUR=$(date -u +%H)
          echo "å½“å‰UTCæ—¶é—´: $UTC_HOUR:00"
          
          # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
          BEIJING_HOUR=$(( (UTC_HOUR + 8) % 24 ))
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $BEIJING_HOUR:00"
          
          # åˆ¤æ–­æ¶ˆæ¯ç±»å‹
          if [ $BEIJING_HOUR -lt 12 ]; then
            echo "PERIOD=morning" >> $GITHUB_OUTPUT
            echo "SCHEDULE_NAME=ä¸Šåˆæé†’" >> $GITHUB_OUTPUT
            echo "ğŸ•˜ å‘é€ä¸Šåˆæé†’æ¶ˆæ¯"
          else
            echo "PERIOD=afternoon" >> $GITHUB_OUTPUT
            echo "SCHEDULE_NAME=ä¸‹åˆæé†’" >> $GITHUB_OUTPUT
            echo "ğŸ•’ å‘é€ä¸‹åˆæé†’æ¶ˆæ¯"
          fi

      - name: Send Feishu Message with Fresh Signature
        id: send-message
        run: |
          echo "ğŸš€ å‡†å¤‡å‘é€é£ä¹¦æ¶ˆæ¯..."
          
          # è·å–åŒ—äº¬æ—¶é—´
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $BEIJING_TIME"
          
          # åœ¨å‘é€å‰ç«‹å³ç”Ÿæˆç­¾åï¼ˆç¡®ä¿æ—¶é—´æˆ³æœ€æ–°ï¼‰
          TIMESTAMP=$(date +%s)
          NONCE=$(openssl rand -hex 16)
          
          echo "ç­¾åæ—¶é—´æˆ³: $TIMESTAMP"
          echo "å½“å‰æ—¶é—´æˆ³: $(date +%s)"
          echo "æ—¶é—´å·®: 0 ç§’ (å®æ—¶ç”Ÿæˆ)"
          
          # ç”Ÿæˆé£ä¹¦ç­¾å (å®˜æ–¹æ¨èæ–¹æ³•)
          SIGNATURE_STRING="${TIMESTAMP}\n${FEISHU_SIGN_SECRET}"
          SIGNATURE=$(echo -n -e "$SIGNATURE_STRING" | openssl dgst -sha256 -binary | base64)
          
          echo "ç”Ÿæˆçš„ç­¾å: $SIGNATURE"
          
          # æ ¹æ®æ—¶é—´æ®µé€‰æ‹©æ¶ˆæ¯å†…å®¹
          if [ "${{ steps.time-check.outputs.PERIOD }}" == "morning" ]; then
            echo "ğŸ•˜ å‘é€ä¸Šåˆæ¶ˆæ¯"
            MESSAGE_JSON='{
              "msg_type": "interactive",
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "ğŸŒ æ—©å®‰ï¼å¼€å§‹ä»Šå¤©çš„å·¥ä½œå§"
                  },
                  "template": "wathet"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**ğŸ“‹ ä»Šæ—¥å·¥ä½œæé†’**\n\nğŸ¯ **é‡è¦ä»»åŠ¡æ£€æŸ¥ï¼š**\nâ€¢ 60è¡¨æ˜¯å¦å·²ä¸Šä¼ ï¼Ÿ\nâ€¢ æ˜¨æ—¥å·¥ä½œæ˜¯å¦å·²å®Œæˆï¼Ÿ\nâ€¢ ä»Šæ—¥è®¡åˆ’æ˜¯å¦æ˜ç¡®ï¼Ÿ\n\nğŸ’« **ä»Šæ—¥å¯„è¯­ï¼š**\næ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ï¼ä¿æŒç§¯æå¿ƒæ€ï¼Œå·¥ä½œæ•ˆç‡ç¿»å€ï¼ğŸš€\n\nâ° **æé†’æ—¶é—´ï¼š** '"$BEIJING_TIME"'\nğŸ”§ **è§¦å‘æ–¹å¼ï¼š** '"${{ github.event_name }}"'"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "ğŸŒˆ **å·¥ä½œå°è´´å£«ï¼š**\nâ€¢ å…ˆå®Œæˆæœ€é‡è¦çš„ä»»åŠ¡\nâ€¢ ä¿æŒä¸“æ³¨ï¼Œä¸€æ¬¡åªåšä¸€ä»¶äº‹\nâ€¢ è®°å¾—é€‚å½“ä¼‘æ¯ï¼Œä¿æŠ¤çœ¼ç›\nâ€¢ ä¿æŒæ¡Œé¢æ•´æ´ï¼Œå¿ƒæƒ…æ›´æ„‰æ‚¦"
                    }
                  }
                ]
              }
            }'
          else
            echo "ğŸ•’ å‘é€ä¸‹åˆæ¶ˆæ¯"
            MESSAGE_JSON='{
              "msg_type": "interactive",
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "â˜• ä¸‹åˆå¥½ï¼ç»§ç»­åŠ æ²¹"
                  },
                  "template": "orange"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**ğŸ“Š ä¸‹åˆå·¥ä½œæ£€æŸ¥**\n\nğŸ¯ **è¿›åº¦ç¡®è®¤ï¼š**\nâ€¢ 60è¡¨æ˜¯å¦å·²æŒ‰æ—¶ä¸Šä¼ ï¼Ÿ\nâ€¢ ä¸Šåˆä»»åŠ¡å®Œæˆæƒ…å†µå¦‚ä½•ï¼Ÿ\nâ€¢ ä¸‹åˆå·¥ä½œé‡ç‚¹æ˜ç¡®äº†å—ï¼Ÿ\n\nğŸ’ª **åŠ æ²¹é¼“åŠ±ï¼š**\nä¸‹åˆæ˜¯åˆ›é€ å¥‡è¿¹çš„æ—¶é—´ï¼ç»§ç»­ä¿æŒä¸“æ³¨ï¼Œèƒœåˆ©åœ¨æœ›ï¼âœ¨\n\nâ° **æé†’æ—¶é—´ï¼š** '"$BEIJING_TIME"'\nğŸ”§ **è§¦å‘æ–¹å¼ï¼š** '"${{ github.event_name }}"'"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "ğŸŒŸ **ä¸‹åˆå·¥ä½œå»ºè®®ï¼š**\nâ€¢ å›é¡¾ä¸Šåˆè¿›åº¦ï¼Œè°ƒæ•´ä¸‹åˆè®¡åˆ’\nâ€¢ å¤„ç†éœ€è¦æ·±åº¦æ€è€ƒçš„ä»»åŠ¡\nâ€¢ é€‚å½“æ´»åŠ¨ï¼Œä¿æŒç²¾åŠ›å……æ²›\nâ€¢ ä¸ºæ˜å¤©çš„å·¥ä½œåšå¥½å‡†å¤‡"
                    }
                  }
                ]
              }
            }'
          fi
          
          echo "ğŸ“¤ å‘é€è¯·æ±‚åˆ°é£ä¹¦..."
          echo "URL: $FEISHU_WEBHOOK_URL"
          echo "Timestamp: $TIMESTAMP"
          echo "Nonce: $NONCE"
          echo "Signature: $SIGNATURE"
          
          # å‘é€è¯·æ±‚
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Lark-Signature: $SIGNATURE" \
            -H "X-Lark-Request-Timestamp: $TIMESTAMP" \
            -H "X-Lark-Request-Nonce: $NONCE" \
            -d "$MESSAGE_JSON")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "=== å“åº”è¯¦æƒ… ==="
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹: $RESPONSE_BODY"
          echo "================"
          
          # æ£€æŸ¥å“åº”
          if [ "$HTTP_CODE" -eq 200 ]; then
            if echo "$RESPONSE_BODY" | grep -q '"StatusCode":0'; then
              echo "âœ… æ¶ˆæ¯å‘é€æˆåŠŸï¼"
              echo "result=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ é£ä¹¦APIè¿”å›é”™è¯¯"
              echo "é”™è¯¯è¯¦æƒ…: $RESPONSE_BODY"
              echo "result=failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ HTTPè¯·æ±‚å¤±è´¥"
            echo "çŠ¶æ€ç : $HTTP_CODE"
            echo "é”™è¯¯è¯¦æƒ…: $RESPONSE_BODY"
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Retry Without Signature
        if: steps.send-message.outputs.result == 'failed'
        run: |
          echo "ğŸ”„ ç­¾åéªŒè¯å¤±è´¥ï¼Œå°è¯•æ— ç­¾åé‡è¯•"
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          # æ„å»ºç®€å•æ¶ˆæ¯
          SIMPLE_JSON='{
            "msg_type": "text",
            "content": {
              "text": "ğŸ“… '"${{ steps.time-check.outputs.SCHEDULE_NAME }}"'\nâ° æ—¶é—´: '"$BEIJING_TIME"'\n\nğŸ“‹ ä»Šæ—¥æé†’ï¼š\nâ€¢ 60è¡¨ä¸Šä¼ æ£€æŸ¥\nâ€¢ å·¥ä½œè¿›åº¦ç¡®è®¤\nâ€¢ è®¡åˆ’æ‰§è¡Œæƒ…å†µ\n\nğŸ’ª ä¿æŒä¸“æ³¨ï¼Œé«˜æ•ˆå·¥ä½œï¼"
            }
          }'
          
          # æ— ç­¾åå‘é€
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$SIMPLE_JSON")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "æ— ç­¾åé‡è¯•å“åº”:"
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] && echo "$RESPONSE_BODY" | grep -q '"StatusCode":0'; then
            echo "âœ… æ— ç­¾åæ¶ˆæ¯å‘é€æˆåŠŸ"
          else
            echo "âŒ æ— ç­¾åæ¶ˆæ¯ä¹Ÿå¤±è´¥äº†"
          fi

      - name: Final Status Report
        run: |
          echo "=== ä»»åŠ¡æ‰§è¡Œç»“æœ ==="
          echo "æ¶ˆæ¯ç±»å‹: ${{ steps.time-check.outputs.SCHEDULE_NAME }}"
          echo "å‘é€æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "æ‰§è¡Œç»“æœ: ${{ steps.send-message.outputs.result }}"
          
          if [ "${{ steps.send-message.outputs.result }}" == "success" ]; then
            echo "ğŸ‰ ä»»åŠ¡å®Œæˆ - æ¶ˆæ¯å‘é€æˆåŠŸ"
          else
            echo "âš ï¸ ä»»åŠ¡å®Œæˆ - ä½¿ç”¨äº†å›é€€æ–¹æ¡ˆ"
            echo "å»ºè®®æ£€æŸ¥é£ä¹¦æœºå™¨äººçš„ç­¾åå¯†é’¥é…ç½®"
          fi
