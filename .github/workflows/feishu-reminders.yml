name: Feishu Daily Reminder

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹ (UTC+8) = UTCæ—¶é—´å‡Œæ™¨1ç‚¹
    - cron: '0 1 * * *'
    # åŒ—äº¬æ—¶é—´ä¸‹åˆ3ç‚¹ (UTC+8) = UTCæ—¶é—´æ—©ä¸Š7ç‚¹
    - cron: '0 7 * * *'

jobs:
  send-daily-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Check Current Time
        id: time-check
        run: |
          # è·å–å½“å‰UTCæ—¶é—´
          UTC_HOUR=$(date -u +%H)
          echo "Current UTC hour: $UTC_HOUR"
          
          # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
          BEIJING_HOUR=$(( (UTC_HOUR + 8) % 24 ))
          echo "Current Beijing hour: $BEIJING_HOUR"
          
          # åˆ¤æ–­æ˜¯ä¸Šåˆè¿˜æ˜¯ä¸‹åˆ
          if [ $BEIJING_HOUR -lt 12 ]; then
            echo "CURRENT_PERIOD=morning" >> $GITHUB_OUTPUT
            echo "It's morning in Beijing"
          else
            echo "CURRENT_PERIOD=afternoon" >> $GITHUB_OUTPUT
            echo "It's afternoon in Beijing"
          fi

      - name: Send Morning Message
        if: |
          (github.event.schedule == '0 1 * * *') ||
          (github.event_name == 'workflow_dispatch' && steps.time-check.outputs.CURRENT_PERIOD == 'morning')
        run: |
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          curl -X POST \
            '${{ secrets.FEISHU_WEBHOOK_URL }}' \
            -H 'Content-Type: application/json' \
            -d '{
              "msg_type": "interactive",
              "card": {
                "elements": [{
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "ğŸŒ **ä¸Šåˆå·¥ä½œæé†’**\n\næ–°çš„ä¸€å¤©å¼€å§‹å•¦ï¼\nâ€¢ 60è¡¨æ˜¯å¦å·²ä¸Šä¼ ï¼Ÿ\nâ€¢ ä»Šæ—¥å·¥ä½œè®¡åˆ’æ˜ç¡®äº†å—ï¼Ÿ\nâ€¢ é‡è¦äº‹é¡¹ä¼˜å…ˆå®‰æ’\nâ€¢ ä¿æŒé«˜æ•ˆå·¥ä½œçŠ¶æ€ ğŸš€\n\nâ° æé†’æ—¶é—´: '"$BEIJING_TIME"'"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**ä»Šæ—¥é‡ç‚¹ï¼š**\nâ€¢ æ£€æŸ¥60è¡¨ä¸Šä¼ çŠ¶æ€\nâ€¢ è§„åˆ’å…¨å¤©å·¥ä½œå®‰æ’\nâ€¢ è®¾å®šä»Šæ—¥ç›®æ ‡\nâ€¢ ä¿æŒç§¯æå¿ƒæ€ï¼ŒåŠ æ²¹ï¼ğŸ’ª"
                    }
                  }
                ],
                "header": {
                  "template": "wathet",
                  "title": {
                    "content": "ğŸŒ… æ—©å®‰æé†’ | ä¸Šåˆå·¥ä½œ",
                    "tag": "plain_text"
                  }
                }
              }
            }'
          echo "âœ… ä¸Šåˆæé†’æ¶ˆæ¯å·²å‘é€ - $BEIJING_TIME"

      - name: Send Afternoon Message
        if: |
          (github.event.schedule == '0 7 * * *') ||
          (github.event_name == 'workflow_dispatch' && steps.time-check.outputs.CURRENT_PERIOD == 'afternoon')
        run: |
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          curl -X POST \
            '${{ secrets.FEISHU_WEBHOOK_URL }}' \
            -H 'Content-Type: application/json' \
            -d '{
              "msg_type": "interactive",
              "card": {
                "elements": [{
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "â˜• **ä¸‹åˆå·¥ä½œæé†’**\n\nä¸‹åˆæ—¶å…‰ï¼Œç»§ç»­åŠ æ²¹ï¼\nâ€¢ 60è¡¨æ˜¯å¦å·²æŒ‰æ—¶ä¸Šä¼ ï¼Ÿ\nâ€¢ ä¸Šåˆå·¥ä½œè¿›åº¦å›é¡¾\nâ€¢ ä¸‹åˆä»»åŠ¡é‡ç‚¹å®‰æ’\nâ€¢ ä¿æŒé«˜æ•ˆçŠ¶æ€ ğŸš€\n\nâ° æé†’æ—¶é—´: '"$BEIJING_TIME"'"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**è¿›åº¦æ£€æŸ¥ï¼š**\nâ€¢ 60è¡¨ä¸Šä¼ çŠ¶æ€ç¡®è®¤\nâ€¢ ä¸Šåˆä»»åŠ¡å®Œæˆæƒ…å†µ\nâ€¢ ä¸‹åˆé‡ç‚¹äº‹é¡¹å®‰æ’\nâ€¢ æ˜æ—¥è®¡åˆ’å‡†å¤‡\n\nç»§ç»­åŠªåŠ›ï¼Œèƒœåˆ©åœ¨æœ›ï¼âœ¨"
                    }
                  }
                ],
                "header": {
                  "template": "orange",
                  "title": {
                    "content": "ğŸŒ… åˆåæé†’ | ä¸‹åˆå·¥ä½œ",
                    "tag": "plain_text"
                  }
                }
              }
            }'
          echo "âœ… ä¸‹åˆæé†’æ¶ˆæ¯å·²å‘é€ - $BEIJING_TIME"

      - name: Log Completion
        run: |
          echo "ğŸ‰ é£ä¹¦æé†’ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
