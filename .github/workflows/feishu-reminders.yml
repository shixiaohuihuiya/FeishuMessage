name: Test Feishu Bot Connection

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-feishu-bot:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test Feishu Bot Connection
      run: |
        # å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°é£ä¹¦æœºå™¨äºº
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "https://open.feishu.cn/open-apis/bot/v2/hook/9057b68c-ebfc-4a5a-9a43-7a878b04b258" \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "ğŸ¤– GitHub Action æµ‹è¯•"
                },
                "template": "blue"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**âœ… é£ä¹¦æœºå™¨äººè¿æ¥æµ‹è¯•æˆåŠŸï¼**\n\nğŸ“… æ—¶é—´ï¼š'"$(date)"'\nğŸ”— ä»“åº“ï¼š${{ github.repository }}\nğŸ¯ åˆ†æ”¯ï¼š${{ github.ref }}\nğŸ‘¤ è§¦å‘è€…ï¼š${{ github.actor }}\n\nè¿™æ˜¯ä¸€æ¡æ¥è‡ª GitHub Actions çš„è‡ªåŠ¨æµ‹è¯•æ¶ˆæ¯ï¼Œè¯æ˜é£ä¹¦æœºå™¨äººé…ç½®æ­£å¸¸ã€‚"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "tag": "plain_text",
                        "content": "æŸ¥çœ‹ä»“åº“"
                      },
                      "type": "primary",
                      "url": "https://github.com/${{ github.repository }}"
                    }
                  ]
                }
              ]
            }
          }')
        
        # æå– HTTP çŠ¶æ€ç å’Œå“åº”ä½“
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "HTTP Status Code: $http_code"
        echo "Response: $response_body"
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ (HTTP 200 ä¸”åŒ…å« success)
        if [ "$http_code" -eq 200 ] && echo "$response_body" | grep -q "success"; then
          echo "âœ… é£ä¹¦æœºå™¨äººè¿æ¥æµ‹è¯•æˆåŠŸï¼"
          exit 0
        else
          echo "âŒ é£ä¹¦æœºå™¨äººè¿æ¥å¤±è´¥"
          echo "é”™è¯¯è¯¦æƒ…ï¼š$response_body"
          exit 1
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ é£ä¹¦æœºå™¨äººæµ‹è¯•å®Œæˆï¼Œæ¶ˆæ¯å·²æˆåŠŸå‘é€ï¼"
        echo "è¯·æ£€æŸ¥é£ä¹¦ç¾¤èŠæ˜¯å¦æ”¶åˆ°æµ‹è¯•æ¶ˆæ¯ã€‚"

    - name: Failure Notification
      if: failure()
      run: |
        echo "ğŸ’¥ é£ä¹¦æœºå™¨äººæµ‹è¯•å¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥ï¼š"
        echo "1. Webhook URL æ˜¯å¦æ­£ç¡®"
        echo "2. æœºå™¨äººæ˜¯å¦åœ¨ç¾¤èŠä¸­å¯ç”¨"
        echo "3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
